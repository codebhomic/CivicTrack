{% extends "base_layout.html" %}
{% block title %}Register {% endblock %}

{% block content %}

<div class="max-w-3xl mx-auto py-8 px-4">
  <h1 class="text-2xl font-bold mb-4">Report a Civic Issue</h1>

  <form action="{{ url_for('report_issue') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
    <div>
      <label for="title" class="block text-sm font-medium">Title</label>
      <input type="text" name="title" id="title" required
             class="mt-1 block w-full rounded border-gray-300 dark:bg-gray-800 dark:border-gray-700">
    </div>

    <div>
      <label for="description" class="block text-sm font-medium">Description</label>
      <textarea name="description" id="description" rows="4" required
                class="mt-1 block w-full rounded border-gray-300 dark:bg-gray-800 dark:border-gray-700"></textarea>
    </div>

    <div>
      <label for="category" class="block text-sm font-medium">Category</label>
      <select name="category" id="category" required
              class="mt-1 block w-full rounded border-gray-300 dark:bg-gray-800 dark:border-gray-700">
        {% for cat in categories %}
          <option value="{{ cat.id }}">{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="image_url" class="block text-sm font-medium">Image URL</label>
      <input type="url" name="image_url" id="image_url"
             class="mt-1 block w-full rounded border-gray-300 dark:bg-gray-800 dark:border-gray-700"
             placeholder="Optional image link...">
    </div>

    <div>
      <label class="block text-sm font-medium">Select Location</label>
      <div id="map" class="h-64 w-full rounded border border-gray-300 dark:border-gray-700 mb-2"></div>
      <input type="hidden" name="latitude" id="latitude">
      <input type="hidden" name="longitude" id="longitude">
    </div>

    <button type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      Submit Issue
    </button>
  </form>
</div>

<script>
  const defaultLat = 30.7333;
  const defaultLng = 76.7794;
  const map = L.map('map').setView([defaultLat, defaultLng], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

  function updateCoords(lat, lng) {
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
  }

  updateCoords(defaultLat, defaultLng);

  marker.on('dragend', function (e) {
    const { lat, lng } = marker.getLatLng();
    updateCoords(lat, lng);
  });

  map.on('click', function (e) {
    marker.setLatLng(e.latlng);
    updateCoords(e.latlng.lat, e.latlng.lng);
  });
</script>
{% endblock %}
